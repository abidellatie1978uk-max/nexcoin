rules_version = '2'; 

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // FUN√á√ïES AUXILIARES
    // ========================================
    
    // Verifica se o usu√°rio est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }    
    
    // Verifica se o usu√°rio √© o dono do documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // üÜï Verifica se o usu√°rio √© administrador
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // ========================================
    // COLE√á√ÉO USERS
    // ========================================
    
    // Regra para a cole√ß√£o de usu√°rios
    match /users/{userId} {
      // üîì ATUALIZADO: Permitir leitura limitada para valida√ß√µes (ex: buscar nome do destinat√°rio)
      // Isso √© necess√°rio para mostrar o nome do destinat√°rio nas transfer√™ncias
      allow read: if isAuthenticated();
      
      // Permitir cria√ß√£o de novo usu√°rio quando autenticado
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // ‚úÖ ATUALIZADO: Permitir atualiza√ß√£o do pr√≥prio documento OU se for administrador
      allow update: if isOwner(userId) || isAdmin();
      
      // üóëÔ∏è ATUALIZADO: Permitir dele√ß√£o do pr√≥prio documento (exclus√£o de conta) OU se for administrador
      allow delete: if isOwner(userId) || isAdmin();
      
      // ========================================
      // SUBCOLE√á√ÉO: PORTFOLIO
      // ========================================
      // ‚úÖ ATUALIZADO: Permitir cr√©ditos de outros usu√°rios para transfer√™ncias
      match /portfolio/{portfolioDoc} {
        // Leitura: permitir para TODOS os usu√°rios autenticados
        // Isso √© necess√°rio para verificar saldos antes de creditar em transfer√™ncias
        allow read: if isAuthenticated();
        
        // Cria√ß√£o: permitir quando:
        // 1. √â o pr√≥prio usu√°rio OU
        // 2. √â outro usu√°rio criando uma posi√ß√£o (para transfer√™ncias)
        allow create: if isOwner(userId) || isAuthenticated();
        
        // Atualiza√ß√£o: permitir quando:
        // 1. √â o pr√≥prio usu√°rio OU
        // 2. √â outro usu√°rio CREDITANDO (aumentando o saldo)
        allow update: if isOwner(userId) || 
                         (isAuthenticated() && 
                          request.resource.data.amount > resource.data.amount);
        
        // Dele√ß√£o: permitir apenas para o pr√≥prio usu√°rio (para limpeza de documentos inv√°lidos)
        allow delete: if isOwner(userId);
      }
      
      // ========================================
      // SUBCOLE√á√ÉO: WALLETS (depreciado, mantido para compatibilidade)
      // ========================================
      match /wallets/{walletId} {
        allow read, write: if isOwner(userId);
      }
      
      // ========================================
      // SUBCOLE√á√ÉO: WALLET ADDRESSES
      // ========================================
      // üîì NOVO: Endere√ßos de carteira para recebimento de criptos
      match /walletAddresses/{network} {
        // üîì IMPORTANTE: Permitir leitura para TODOS os usu√°rios autenticados
        // Isso √© necess√°rio para validar o destinat√°rio nas transfer√™ncias
        allow read: if isAuthenticated();
        
        // Escrita: apenas o pr√≥prio usu√°rio pode criar/atualizar seus endere√ßos
        allow write: if isOwner(userId);
      }
      
      // ========================================
      // SUBCOLE√á√ÉO: RECEIVE ADDRESSES (depreciado, mantido para compatibilidade)
      // ========================================
      match /receiveAddresses/{addressId} {
        allow read: if isAuthenticated(); // Permitir leitura para valida√ß√µes
        allow write: if isOwner(userId);
      }
      
      // ========================================
      // SUBCOLE√á√ÉO: CONVERSIONS
      // ========================================
      match /conversions/{conversionId} {
        allow read, write, delete: if isOwner(userId);
      }
      
      // ========================================
      // SUBCOLE√á√ÉO: FIAT BALANCES
      // ========================================
      // ‚úÖ ATUALIZADO: Permitir cr√©ditos de outros usu√°rios para transfer√™ncias PIX
      match /fiatBalances/{currency} {
        // Leitura: permitir para TODOS os usu√°rios autenticados
        // Isso √© necess√°rio para verificar saldos antes de creditar em transfer√™ncias PIX
        allow read: if isAuthenticated();
        
        // Cria√ß√£o: permitir quando:
        // 1. √â o pr√≥prio usu√°rio OU
        // 2. √â outro usu√°rio criando um saldo (para transfer√™ncias)
        allow create: if isOwner(userId) || isAuthenticated();
        
        // Atualiza√ß√£o: permitir quando:
        // 1. √â o pr√≥prio usu√°rio OU
        // 2. √â outro usu√°rio CREDITANDO (aumentando o saldo)
        // ‚úÖ IMPORTANTE: Verificar campo 'balance' (n√£o 'amount')
        allow update: if isOwner(userId) || 
                         (isAuthenticated() && 
                          request.resource.data.balance > resource.data.balance);
        
        // üóëÔ∏è ATUALIZADO: Permitir dele√ß√£o pelo pr√≥prio usu√°rio (exclus√£o de conta)
        allow delete: if isOwner(userId);
      }
      
      // ========================================
      // SUBCOLE√á√ÉO: FIAT TRANSACTIONS
      // ========================================
      match /fiatTransactions/{transactionId} {
        // Leitura: apenas o pr√≥prio usu√°rio
        allow read: if isOwner(userId);
        
        // Cria√ß√£o: permitir do pr√≥prio usu√°rio
        allow create: if isOwner(userId);
        
        // üóëÔ∏è ATUALIZADO: Permitir dele√ß√£o pelo pr√≥prio usu√°rio (exclus√£o de conta)
        // Transa√ß√µes normalmente s√£o imut√°veis, mas permitir dele√ß√£o para exclus√£o de conta
        allow update: if false;
        allow delete: if isOwner(userId);
      }
      
      // ========================================
      // SUBCOLE√á√ÉO: TRANSACTIONS
      // ========================================
      // ‚úÖ ATUALIZADO: Permitir cria√ß√£o de transa√ß√µes de recebimento por terceiros
      match /transactions/{transactionId} {
        // Leitura: apenas o pr√≥prio usu√°rio
        allow read: if isOwner(userId);
        
        // Cria√ß√£o: permitir quando:
        // 1. √â o pr√≥prio usu√°rio OU
        // 2. √â outro usu√°rio criando transa√ß√£o de RECEBIMENTO com valor positivo
        allow create: if isOwner(userId) || 
                         (isAuthenticated() && 
                          request.resource.data.type in ['crypto_receive', 'pix_receive', 'transfer_receive'] &&
                          request.resource.data.amount > 0);
        
        // üóëÔ∏è ATUALIZADO: Permitir dele√ß√£o pelo pr√≥prio usu√°rio (exclus√£o de conta)
        // Transa√ß√µes normalmente s√£o imut√°veis, mas permitir dele√ß√£o para exclus√£o de conta
        allow update: if false;
        allow delete: if isOwner(userId);
      }
      
      // ========================================
      // SUBCOLE√á√ÉO: AUDIT LOGS
      // ========================================
      match /auditLogs/{logId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false; // Logs s√£o imut√°veis
      }
      
      // ========================================
      // SUBCOLE√á√ÉO: PREFERENCES
      // ========================================
      match /preferences/{preferenceId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ========================================
    // PERMITIR BUSCA POR TELEFONE (LOGIN)
    // ========================================
    // ‚ö†Ô∏è IMPORTANTE: Permitir busca por telefone para login
    // Esta regra permite queries limitadas na cole√ß√£o users
    match /users/{document=**} {
      // Permitir leitura (list) com limite de at√© 10 resultados
      // Necess√°rio para login por telefone + PIN
      allow list: if request.query.limit <= 10;
    }
    
    // ========================================
    // COLE√á√ÉO: WALLET ADDRESS INDEX
    // ========================================
    // üÜï NOVO: √çndice global para busca r√°pida de endere√ßos de carteira
    // Estrutura: {addressId} -> { userId, network, address, createdAt }
    match /walletAddressIndex/{addressId} {
      // üîì IMPORTANTE: Permitir leitura para TODOS os usu√°rios autenticados
      // Isso √© necess√°rio para buscar rapidamente o destinat√°rio nas transfer√™ncias
      // sem precisar fazer queries pesadas em subcole√ß√µes
      allow read: if isAuthenticated();
      
      // Escrita: permitir quando:
      // 1. √â o pr√≥prio usu√°rio criando/atualizando seu endere√ßo
      // 2. O userId no documento corresponde ao usu√°rio autenticado
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Atualiza√ß√£o: apenas o pr√≥prio usu√°rio pode atualizar seus endere√ßos
      // E garantir que o userId n√£o pode ser alterado
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid;
      
      // Dele√ß√£o: apenas o pr√≥prio usu√°rio pode deletar seus endere√ßos
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Permitir queries/listagem no √≠ndice de endere√ßos (necess√°rio para buscar por address)
    match /walletAddressIndex/{document=**} {
      allow list: if isAuthenticated() && 
                     request.query.limit <= 100;
    }
    
    // ========================================
    // COLE√á√ÉO: BANK ACCOUNTS
    // ========================================
    // üè¶ Contas banc√°rias do usu√°rio (BRL, USD, EUR, etc)
    match /bankAccounts/{accountId} {
      // Leitura: apenas o pr√≥prio usu√°rio
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Cria√ß√£o: apenas o pr√≥prio usu√°rio
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Atualiza√ß√£o: apenas o pr√≥prio usu√°rio
      // E garantir que o userId n√£o pode ser alterado
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid;
      
      // Dele√ß√£o: apenas o pr√≥prio usu√°rio (exclus√£o de conta)
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Permitir queries/listagem de contas banc√°rias do usu√°rio
    match /bankAccounts/{document=**} {
      allow list: if isAuthenticated() && 
                     request.query.limit <= 50;
    }
    
    // ========================================
    // COLE√á√ÉO: PIX KEYS
    // ========================================
    // üîì ATUALIZADO: Permitir leitura de chaves PIX para transfer√™ncias
    match /pixKeys/{keyId} {
      // üîì IMPORTANTE: Permitir leitura para TODOS os usu√°rios autenticados
      // Isso √© necess√°rio para buscar o destinat√°rio nas transfer√™ncias PIX
      allow read: if isAuthenticated();
      
      // Permitir cria√ß√£o de nova chave PIX vinculada ao usu√°rio autenticado
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Permitir atualiza√ß√£o apenas das pr√≥prias chaves PIX
      // E garantir que o userId n√£o pode ser alterado
      allow update: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid;
      
      // Permitir dele√ß√£o apenas das pr√≥prias chaves PIX
      allow delete: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
    }
    
    // Permitir queries/listagem de chaves PIX (necess√°rio para buscar por chave)
    match /pixKeys/{document=**} {
      allow list: if isAuthenticated() && 
                     request.query.limit <= 100;
    }
    
    // ========================================
    // COLE√á√ÉO: BIOMETRIC CREDENTIALS
    // ========================================
    // üîê Credenciais biom√©tricas dos usu√°rios
    // Estrutura: {userId} -> { credentialId, publicKey, counter, createdAt, lastUsed, deviceInfo }
    match /biometricCredentials/{userId} {
      // Leitura: apenas o pr√≥prio usu√°rio pode ler suas credenciais
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Cria√ß√£o: apenas o pr√≥prio usu√°rio pode criar suas credenciais
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Atualiza√ß√£o: apenas o pr√≥prio usu√°rio pode atualizar suas credenciais
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // Dele√ß√£o: apenas o pr√≥prio usu√°rio pode deletar suas credenciais
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================
    // COLE√á√ÉO: NOTIFICATIONS
    // ========================================
    // üîî Notifica√ß√µes do usu√°rio
    // Estrutura: { userId, type, title, message, timestamp, read, metadata }
    match /notifications/{notificationId} {
      // Leitura: apenas o pr√≥prio usu√°rio pode ler suas notifica√ß√µes
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Cria√ß√£o: apenas o pr√≥prio usu√°rio pode criar suas notifica√ß√µes
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Atualiza√ß√£o: apenas o pr√≥prio usu√°rio pode atualizar suas notifica√ß√µes
      // (por exemplo, marcar como lida)
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid;
      
      // Dele√ß√£o: apenas o pr√≥prio usu√°rio pode deletar suas notifica√ß√µes
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Permitir queries/listagem de notifica√ß√µes do usu√°rio
    match /notifications/{document=**} {
      allow list: if isAuthenticated() && 
                     request.query.limit <= 500;
    }
    
    // ========================================
    // COLE√á√ÉO: CARDS
    // ========================================
    // üí≥ Cart√µes f√≠sicos e virtuais dos usu√°rios
    match /cards/{cardId} {
      // Leitura: apenas o pr√≥prio usu√°rio
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Cria√ß√£o: apenas o pr√≥prio usu√°rio
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // Atualiza√ß√£o: apenas o pr√≥prio usu√°rio
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      // Dele√ß√£o: apenas o pr√≥prio usu√°rio
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Permitir queries/listagem de cart√µes do usu√°rio
    match /cards/{document=**} {
      allow list: if isAuthenticated() && 
                     request.query.limit <= 50;
    }

    // ========================================
    // COLE√á√ÉO: TRANSACTIONS GLOBAL (depreciado)
    // ========================================
    // NOTA: Esta cole√ß√£o √© para transa√ß√µes que N√ÉO s√£o espec√≠ficas de um usu√°rio
    // Para transa√ß√µes de cripto de um usu√°rio, use users/{userId}/transactions
    match /transactions/{transactionId} {
      // Permitir leitura apenas das pr√≥prias transa√ß√µes
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Permitir cria√ß√£o de nova transa√ß√£o vinculada ao usu√°rio autenticado
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // üóëÔ∏è ATUALIZADO: Permitir dele√ß√£o pelo pr√≥prio usu√°rio (exclus√£o de conta)
      // Transa√ß√µes normalmente s√£o imut√°veis, mas permitir dele√ß√£o para exclus√£o de conta
      allow update: if false;
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Permitir queries/listagem de transa√ß√µes do usu√°rio
    match /transactions/{document=**} {
      allow list: if isAuthenticated() && 
                     request.query.limit <= 500;
    }
    
    // ========================================
    // COLE√á√ÉO: CONVERSIONS GLOBAL
    // ========================================
    match /conversions/{conversionId} {
      // Permitir leitura apenas das pr√≥prias convers√µes
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Permitir cria√ß√£o de nova convers√£o vinculada ao usu√°rio autenticado
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
      
      // üóëÔ∏è ATUALIZADO: Permitir dele√ß√£o pelo pr√≥prio usu√°rio (exclus√£o de conta)
      // Convers√µes normalmente s√£o imut√°veis, mas permitir dele√ß√£o para exclus√£o de conta
      allow update: if false;
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Permitir queries/listagem de convers√µes do usu√°rio
    match /conversions/{document=**} {
      allow list: if isAuthenticated() && 
                     request.query.limit <= 500;
    }
    
    // ========================================
    // COLE√á√ÉO: USER LOCATIONS
    // ========================================
    // üìç Localiza√ß√µes GPS dos usu√°rios em tempo real
    // Estrutura: {userId} -> { userId, userEmail, coordinates: { latitude, longitude }, city, state, country, address, timestamp, updatedAt }
    match /userLocations/{userId} {
      // Leitura: apenas o pr√≥prio usu√°rio pode ler sua localiza√ß√£o
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Cria√ß√£o: apenas o pr√≥prio usu√°rio pode criar sua localiza√ß√£o
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Atualiza√ß√£o: apenas o pr√≥prio usu√°rio pode atualizar sua localiza√ß√£o
      allow update: if isAuthenticated() && request.auth.uid == userId;
      
      // Dele√ß√£o: apenas o pr√≥prio usu√°rio pode deletar sua localiza√ß√£o
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================
    // REGRA PADR√ÉO: NEGAR TUDO
    // ========================================
    // Regra padr√£o: negar tudo que n√£o foi especificado
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
